<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>投资组合仪表盘 | POP MONITOR</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>

    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="pop-bg-pattern"></div>
    <div class="pop-decor-shape shape-circle"></div>
    <div class="pop-decor-shape shape-triangle"></div>
    <div class="pop-decor-shape shape-cross">✖</div>
    <div class="pop-decor-shape shape-squiggle">
        <svg viewBox="0 0 100 20" preserveAspectRatio="none">
            <path d="M0,10 Q25,20 50,10 T100,10" fill="none" stroke="currentColor" stroke-width="5"/>
        </svg>
    </div>

    <div class="main-container">
      <nav class="tab-nav">
        <div class="nav-brand">
            <span class="brand-box">BOOM!</span> MONITOR
        </div>
        <div class="nav-items">
          <button id="tab-summary" class="tab-button active">
            资产概览
          </button>
          <button id="tab-positions" class="tab-button">
            仓位更新
          </button>
          <button id="tab-settings" class="tab-button">
            系统设置
          </button>
        </div>
      </nav>

      <main class="content-area">
        <div class="tradingview-ticker-wrapper">
          <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <script
              type="text/javascript"
              src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js"
              async
            >
                {
                "symbols": [
                  { "proName": "FX:USDCNH", "title": "USD/CNH" },
                  { "proName": "NASDAQ:QQQ", "title": "NASDAQ 100" },
                  { "proName": "AMEX:VOO", "title": "S&P 500" },
                  { "proName": "THINKMARKETS:USDINDEX", "title": "DXY" },
                  { "proName": "INDEX:S5TH", "title": "S&P 200 AVG+" },
                  { "proName": "INDEX:S5FI", "title": "S&P 50 AVG+" }
                ],
                "colorTheme": "light",
                "isTransparent": true,
                "displayMode": "regular",
                "locale": "zh_CN"
              }
            </script>
          </div>
        </div>

        <div id="summary-panel" class="tab-panel active">
          <div id="summary-container">
            <div class="total-value-card pop-border" data-tilt data-tilt-max="2" data-tilt-speed="400" data-tilt-glare data-tilt-max-glare="0.2">
              <div class="total-value-wrapper">
                <span class="label-text">NET LIQUIDATION VALUE</span>
                <div class="value-row">
                    <h1 id="total-value-display" class="clickable-summary">Loading...</h1>
                    <i id="toggle-visibility-btn" class="fas fa-eye" title="切换可见性"></i>
                </div>
              </div>
              <div class="refresh-indicator">
                 <span id="last-updated-time">Checking...</span>
                 <i class="fas fa-wifi"></i>
              </div>
            </div>

            <div id="returns-display" class="returns-grid">
              </div>

            <div class="charts-grid">
              <div class="chart-card value-chart-container pop-card color-accent-1" data-tilt data-tilt-max="1" data-tilt-scale="1.01">
                <div class="card-header">
                    <h3>资产历史堆叠</h3>
                    <div class="live-badge">LIVE</div>
                </div>
                <div class="chart-body">
                    <canvas id="portfolio-value-chart"></canvas>

                    <button id="chart-settings-btn" class="chart-settings-gear">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div id="chart-settings-panel" class="chart-settings-panel">
                         <div class="setting-row">
                            <input type="checkbox" id="simple-tooltip-toggle" />
                            <label for="simple-tooltip-toggle">简化提示框</label>
                         </div>
                         <div class="setting-note">仅显示日期和总价值</div>
                    </div>
                </div>
              </div>

              <div class="chart-card pie-chart-container pop-card color-accent-2" data-tilt data-tilt-max="1" data-tilt-scale="1.01">
                <div class="card-header">
                    <h3>资产分布</h3>
                </div>
                <div class="chart-body">
                    <canvas id="portfolio-pie-chart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div class="fear-greed-wrapper-container">
            <div class="chart-card fear-greed-card pop-card color-accent-3" data-tilt data-tilt-max="1">
              <div class="fear-greed-header">
                <h3>CNN 恐慌与贪婪指数</h3>
                <p id="fg-last-updated">Updating...</p>
              </div>
              <div class="fear-greed-content">
                <div class="gauge-wrapper">
                  <canvas id="fear-greed-gauge"></canvas>
                  <div class="gauge-overlay">
                    <span id="fg-score-value">--</span>
                    <span id="fg-score-rating">Waiting</span>
                  </div>
                </div>
                <div class="history-wrapper">
                  <canvas id="fear-greed-history-chart"></canvas>
                </div>
              </div>
              <div class="fear-greed-stats">
                <div class="stat-box">
                  <span class="lbl">昨日</span>
                  <span id="fg-prev-close" class="val">--</span>
                </div>
                <div class="stat-box">
                  <span class="lbl">上周</span>
                  <span id="fg-prev-week" class="val">--</span>
                </div>
                <div class="stat-box">
                  <span class="lbl">上月</span>
                  <span id="fg-prev-month" class="val">--</span>
                </div>
                <div class="stat-box">
                    <span class="lbl">去年</span>
                    <span id="fg-prev-year" class="val">--</span>
                  </div>
              </div>
            </div>
          </div>

          <div class="vix-section">
             <div class="chart-card pop-card color-accent-1" data-tilt data-tilt-max="1">
                <div class="card-header">
                    <h3>市场波动率 (VIX)</h3>
                    <div id="vix-rating-badge" class="status-badge">--</div>
                </div>
                <div class="chart-body wide-chart">
                    <canvas id="vix-chart"></canvas>
                </div>
             </div>
          </div>

          <div class="market-breadth-grid">
            <div class="chart-card pop-card" data-tilt data-tilt-max="2">
              <div class="card-header">
                <h3>股价强度</h3>
                <div id="strength-rating-badge" class="status-badge">--</div>
              </div>
              <div class="chart-body">
                <canvas id="stock-strength-chart"></canvas>
              </div>
            </div>
            <div class="chart-card pop-card" data-tilt data-tilt-max="2">
              <div class="card-header">
                <h3>股价宽度</h3>
                <div id="breadth-rating-badge" class="status-badge">--</div>
              </div>
              <div class="chart-body">
                <canvas id="stock-breadth-chart"></canvas>
              </div>
            </div>
          </div>

          <div class="macro-section-title">
              <span class="glitch-text" data-text="MACRO ECONOMICS">MACRO ECONOMICS</span>
          </div>

          <div class="chart-card fed-balance-card pop-card color-accent-2" data-tilt data-tilt-max="1">
             <div class="card-header">
                <h3>美联储总资产 (Fed Balance Sheet)</h3>
             </div>
             <div class="chart-body tall-chart">
                <canvas id="fed-balance-sheet-chart"></canvas>
             </div>
          </div>

          <div class="fed-grid">
            <div class="chart-card pop-card" data-tilt>
              <h3>核心 CPI (YoY)</h3>
              <div class="mini-chart-body"><canvas id="core-cpi-chart"></canvas></div>
            </div>
            <div class="chart-card pop-card" data-tilt>
              <h3>核心 PCE (YoY)</h3>
              <div class="mini-chart-body"><canvas id="core-pce-chart"></canvas></div>
            </div>
            <div class="chart-card pop-card" data-tilt>
              <h3>失业率</h3>
              <div class="mini-chart-body"><canvas id="unemployment-rate-chart"></canvas></div>
            </div>
            <div class="chart-card pop-card" data-tilt>
              <h3>消费者信心指数</h3>
              <div class="mini-chart-body"><canvas id="consumer-sentiment-chart"></canvas></div>
            </div>
          </div>

          <div class="control-footer">
            <button id="force-refresh-btn" class="neon-btn cyan-btn">
              <i class="fas fa-sync-alt"></i> 强制刷新
            </button>
            <button id="run-workflow-btn-summary" class="neon-btn purple-btn">
              <i class="fas fa-rocket"></i> 触发更新
            </button>
          </div>
        </div>

        <div id="positions-panel" class="tab-panel">
          <div class="panel-header">
             <h2>仓位管理</h2>
             <p>直接修改下方的配置并保存，系统将自动同步。</p>
          </div>
          <div id="positions-editor"></div>
          <div class="editor-footer">
            <button id="save-btn-positions" class="neon-btn green-btn">
              <i class="fas fa-save"></i> 保存变更
            </button>
            <button id="logout-btn-positions" class="neon-btn red-btn logout-btn hidden">
              <i class="fas fa-sign-out-alt"></i> 清除授权
            </button>
            <div id="status-msg-positions" class="status-msg"></div>
          </div>
        </div>

        <div id="settings-panel" class="tab-panel">
          <div class="panel-header">
            <h2>系统配置</h2>
          </div>
          <div id="settings-editor"></div>
          <div class="editor-footer">
            <button id="save-btn-settings" class="neon-btn green-btn">
              <i class="fas fa-save"></i> 保存配置
            </button>
            <button id="logout-btn-settings" class="neon-btn red-btn logout-btn hidden">
              <i class="fas fa-sign-out-alt"></i> 清除授权
            </button>
            <div id="status-msg-settings" class="status-msg"></div>
          </div>
        </div>
      </main>
    </div>

    <div id="modal-backdrop" class="hidden"></div>
    <div id="token-modal" class="glass-modal hidden">
      <div class="modal-icon"><i class="fas fa-fingerprint"></i></div>
      <h3>身份验证</h3>
      <p>请输入 GitHub Personal Access Token 以获取写权限。</p>
      <div class="input-group">
        <input type="password" id="modal-token-input" placeholder="ghp_xxxxxxxxxxxx" />
      </div>
      <div id="modal-status-msg" class="status-msg"></div>
      <div class="modal-actions">
        <button id="modal-cancel-btn" class="text-btn">取消</button>
        <button id="modal-confirm-btn" class="neon-btn cyan-btn">验证并进入</button>
      </div>
    </div>

    <div id="history-modal-backdrop" class="modal-backdrop-new hidden"></div>
    <div id="history-modal-container" class="glass-modal large hidden">
      <div class="modal-header">
          <h3></h3>
          <span class="close-modal-hint"></span>
      </div>
      <div id="history-table-content"></div>
    </div>

    <script src="script.js"></script>
    <script src="fed_data.js"></script>
    <script src="fear-greed-chart.js"></script>

    <script>
        // 初始化 VanillaTilt
        // 这里使用 MutationObserver 监听 DOM 变化，因为部分元素（如 return-grid）是 JS 动态加载的
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1 && node.classList && node.classList.contains('return-item')) {
                        // 给动态添加的收益率小卡片增加 tilt 效果
                        VanillaTilt.init(node, {
                            max: 5,
                            speed: 400,
                            glare: true,
                            "max-glare": 0.3,
                            scale: 1.05
                        });
                    }
                });
            });
        });

        const returnsContainer = document.getElementById('returns-display');
        if (returnsContainer) {
            observer.observe(returnsContainer, { childList: true });
        }

        // 给所有已经存在的带有 data-tilt 属性的元素初始化
        VanillaTilt.init(document.querySelectorAll("[data-tilt]"), {
             speed: 400,
             glare: true,
             "max-glare": 0.1
        });
    </script>
  </body>
</html>