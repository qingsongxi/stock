# ä¸ºè¿™ä¸ªå·¥ä½œæµå‘½å
name: Sync Upstream

on:
  # ä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹è¿™ä¸ªæ—¶é—´
  schedule:
    - cron: '0 21 * * *'
  # å…è®¸ä½ ä»ä»“åº“çš„ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

jobs:
  sync-with-upstream:
    # ä½¿ç”¨æœ€æ–°ç‰ˆçš„ Ubuntu è™šæ‹Ÿæœºä½œä¸ºè¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºï¼ˆCheckoutï¼‰ä½ çš„ä»“åº“ä»£ç 
      - name: Checkout Your Repository
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 éå¸¸é‡è¦ï¼Œå®ƒè·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿è¿›è¡Œåç»­æ“ä½œ
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œæ ¸å¿ƒè„šæœ¬ï¼šè¿ç§»ã€å¤‡ä»½ã€åŒæ­¥ã€æ¢å¤
      - name: Migrate, Backup, Sync, and Restore
        run: |
          # =================================================================
          # è„šæœ¬å¼€å§‹
          # =================================================================
          
          set -e
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          # --- 1. (æ–°å¢) è‡ªåŠ¨ä¸ºè€ç”¨æˆ·è¿ç§»æ–‡ä»¶ç»“æ„ ---
          echo "Step 1: Checking for legacy file structure and migrating if necessary..."
          if [ -f "portfolio_details_history.csv" ]; then
            echo "  > Legacy structure detected. Migrating data files to the 'data/' directory..."
            mkdir -p data
            find . -maxdepth 1 \( -name "*.csv" -o -name "*.json" -o -name "*.png" \) -exec git mv -f {} data/ \; || true
            echo "  âœ… Migration complete. Your data files are now in the 'data' folder."
            echo "  â„¹ï¸  This change will be committed along with the upstream sync."
          else
            echo "  > Modern 'data/' directory structure confirmed. No migration needed."
          fi

          # --- 2. å¤‡ä»½ä½ çš„æ•°æ®æ–‡ä»¶ ---
          echo "Step 2: Backing up your personal files..."
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥å­˜æ”¾å¤‡ä»½
          mkdir -p .sync_backup_temp
          
          # å¤‡ä»½æ ¹ç›®å½•çš„ config.ini
          if [ -f "config.ini" ]; then
            echo "  > Backing up config.ini..."
            cp config.ini .sync_backup_temp/
          fi
          
          # å¤‡ä»½æ•´ä¸ª data æ–‡ä»¶å¤¹
          if [ -d "data" ]; then
            echo "  > Backing up the entire 'data' directory..."
            cp -r data .sync_backup_temp/
          fi
          echo "âœ… Backup complete."

          # --- 3. åŒæ­¥ä¸Šæ¸¸ä»“åº“ (æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†) ---
          echo "Step 3: Syncing with upstream repository..."
          git remote add upstream https://github.com/cli117/stock_monitor.git 2>/dev/null || echo "Upstream remote already exists"
          echo "  > Fetching from upstream..."
          git fetch upstream
          
          # ç¡®å®šä¸Šæ¸¸çš„ä¸»åˆ†æ”¯æ˜¯ main è¿˜æ˜¯ master
          if git show-ref --verify --quiet refs/remotes/upstream/main; then
            UPSTREAM_BRANCH="upstream/main"
          elif git show-ref --verify --quiet refs/remotes/upstream/master; then
            UPSTREAM_BRANCH="upstream/master"
          else
            echo "âŒ Error: Neither main nor master branch found in upstream repository"
            exit 1
          fi
          
          echo "  > Hard resetting local branch to match $UPSTREAM_BRANCH..."
          # ä½¿ç”¨ git reset --hardï¼Œå¼ºåˆ¶è®©æœ¬åœ°åˆ†æ”¯ä¸ä¸Šæ¸¸åˆ†æ”¯å®Œå…¨ä¸€è‡´
          # è¿™ä¼šä¸¢å¼ƒæœ¬åœ°çš„æ‰€æœ‰ commitï¼Œä»è€Œé¿å…ä»»ä½•åˆå¹¶å†²çª
          git reset --hard $UPSTREAM_BRANCH
          echo "âœ… Reset successful. Local branch now matches upstream."

          # --- 4. æ¢å¤ä½ çš„æ•°æ®æ–‡ä»¶ ---
          echo "Step 4: Restoring your personal files..."
          # æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
          if [ -n "$(ls -A .sync_backup_temp/ 2>/dev/null)" ]; then
            echo "  > Restoring config.ini and the 'data' directory..."
            # -r é€’å½’å¤åˆ¶, -f å¼ºåˆ¶è¦†ç›–ï¼Œå°†å¤‡ä»½çš„å†…å®¹æ¢å¤åˆ°åŸä½
            # ä½¿ç”¨ `cp -rf .sync_backup_temp/. .` ç¡®ä¿èƒ½æ­£ç¡®å¤„ç†éšè—æ–‡ä»¶å’Œç›®å½•
            cp -rf .sync_backup_temp/. .
            echo "âœ… Restore complete."
          else
            echo "â„¹ï¸  No personal files were found in the backup. Nothing to restore."
          fi

          # --- 5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤¹ ---
          echo "Step 5: Cleaning up temporary backup..."
          rm -rf .sync_backup_temp
          echo "âœ… Cleanup complete."

          # --- 6. æäº¤å¹¶æ¨é€æ›´æ–° (æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†) ---
          echo "Step 6: Committing and pushing changes..."
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨ï¼ˆé€šå¸¸æ˜¯æ¢å¤çš„ä¸ªäººæ•°æ®æ–‡ä»¶ï¼‰
          # `git add -A` ä¼šæš‚å­˜æ‰€æœ‰å˜åŠ¨ï¼ŒåŒ…æ‹¬æ¢å¤çš„æ–‡ä»¶å’Œè¿ç§»çš„æ–‡ä»¶
          git add -A
          if git diff --staged --quiet; then
            echo "â„¹ï¸  Your repository is already up-to-date. No push needed."
          else
            echo "ğŸ“ Changes detected. Committing and pushing to your repository..."
            # ä¿®æ”¹ commit ä¿¡æ¯ï¼Œä½¿å…¶æ›´å‡†ç¡®
            git commit -m "chore: Sync with upstream and restore user data [$(date +'%Y-%m-%d %H:%M:%S UTC')]"
            
            echo "  > Force pushing changes to your repository..."
            # å› ä¸ºæˆ‘ä»¬é‡å†™äº†å†å² (git reset --hard)ï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨ --force
            # è¿™åœ¨è¿™ä¸ªåœºæ™¯ä¸‹æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒåªå½±å“ç”¨æˆ·çš„forkä»“åº“
            if git push --force; then
              echo "âœ… Push successful!"
            else
              echo "âŒ Push failed!"
              exit 1
            fi
          fi

          echo "ğŸ‰ Sync completed successfully!"
          
          # =================================================================
          # è„šæœ¬ç»“æŸ
          # =================================================================
